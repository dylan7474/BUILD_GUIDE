#!/bin/bash

# ==============================================================================
# ComfyUI & Stable Video Diffusion Automated Installer for Ubuntu & NVIDIA
# ==============================================================================
# This script automates the installation of ComfyUI, the ComfyUI-Manager,
# and the required models for image and video generation.
#
# Usage:
# 1. Save this script as install_ai_tools.sh
# 2. Make it executable: chmod +x install_ai_tools.sh
# 3. Run it: ./install_ai_tools.sh
# ==============================================================================

# Exit immediately if a command exits with a non-zero status.
set -e

# --- Configuration ---
INSTALL_DIR="$HOME/ai-tools"
COMFYUI_DIR="$INSTALL_DIR/ComfyUI"
VENV_DIR="$COMFYUI_DIR/venv"
SD_MODEL_URL="https://huggingface.co/stabilityai/stable-diffusion-xl-base-1.0/resolve/main/sd_xl_base_1.0.safetensors"
SVD_MODEL_URL="https://huggingface.co/stabilityai/stable-video-diffusion-img2vid-xt/resolve/main/svd_xt.safetensors"
CHECKPOINTS_DIR="$COMFYUI_DIR/models/checkpoints"

# --- Helper Functions ---
print_header() {
    echo "======================================================================"
    echo " $1"
    echo "======================================================================"
}

print_success() {
    echo "‚úÖ $1"
}

# --- Main Installation ---

# 1. System Prerequisites
print_header "Step 1: Installing System Prerequisites"
sudo apt-get update
sudo apt-get install -y git python3 python3-venv wget

# Check for NVIDIA drivers
if ! command -v nvidia-smi &> /dev/null
then
    echo "‚ö†Ô∏è  WARNING: NVIDIA drivers not found. 'nvidia-smi' command failed."
    echo "Please ensure you have installed the proprietary NVIDIA drivers for your GPU."
    echo "The script will continue, but ComfyUI will not work without them."
else
    echo "NVIDIA drivers detected:"
    nvidia-smi --query-gpu=gpu_name,driver_version --format=csv,noheader
fi
print_success "System prerequisites installed."


# 2. Install ComfyUI
print_header "Step 2: Cloning and Setting Up ComfyUI"
mkdir -p "$INSTALL_DIR"
cd "$INSTALL_DIR"

if [ -d "$COMFYUI_DIR" ]; then
    echo "ComfyUI directory already exists. Skipping clone."
else
    git clone https://github.com/comfyanonymous/ComfyUI.git
fi

cd "$COMFYUI_DIR"
print_success "ComfyUI repository cloned."

print_header "Step 3: Creating Python Environment and Installing Dependencies"
if [ -d "$VENV_DIR" ]; then
    echo "Python virtual environment already exists. Skipping creation."
else
    python3 -m venv venv
fi

# Activate venv for this script's context and install packages
source "$VENV_DIR/bin/activate"
pip install --upgrade pip
# Note: Using CUDA 12.1 for PyTorch. Adjust if you have a different setup.
pip install torch torchvision torchaudio --extra-index-url https://download.pytorch.org/whl/cu121
pip install -r requirements.txt
deactivate

print_success "Python dependencies installed."


# 3. Download Models
print_header "Step 4: Downloading AI Models"
mkdir -p "$CHECKPOINTS_DIR"
cd "$CHECKPOINTS_DIR"

echo "Downloading Stable Diffusion XL Base Model (sd_xl_base_1.0.safetensors)..."
wget -nc "$SD_MODEL_URL" # -nc skips download if file exists
print_success "SDXL model downloaded."

echo "Downloading Stable Video Diffusion Model (svd_xt.safetensors)..."
wget -nc "$SVD_MODEL_URL" # -nc skips download if file exists
print_success "SVD model downloaded."


# 4. Install ComfyUI-Manager
print_header "Step 5: Installing the ComfyUI-Manager"
cd "$COMFYUI_DIR/custom_nodes/"
if [ -d "ComfyUI-Manager" ]; then
    echo "ComfyUI-Manager already exists. Skipping clone."
else
    git clone https://github.com/ltdrdata/ComfyUI-Manager.git
fi
print_success "ComfyUI-Manager installed."


# --- Final Instructions ---
print_header "üéâ Installation Complete! üéâ"
echo
echo "All automated steps are finished. Here's how to get started:"
echo
echo "1. Navigate to the ComfyUI directory:"
echo "   cd $COMFYUI_DIR"
echo
echo "2. Activate the Python environment:"
echo "   source venv/bin/activate"
echo
echo "3. Start the ComfyUI server:"
echo "   python3 main.py"
echo
echo "4. Open your web browser and go to: http://127.0.0.1:8188"
echo
echo "--- IMPORTANT FINAL STEP ---"
echo "5. To enable video generation, you MUST install the SVD nodes:"
echo "   - In the ComfyUI web interface, click the 'Manager' button."
echo "   - Click 'Install Custom Nodes'."
echo "   - Search for 'ComfyUI-SVD' and click 'Install'."
echo "   - Restart the ComfyUI server in your terminal (Ctrl+C and run 'python3 main.py' again)."
echo
echo "Enjoy creating!"
